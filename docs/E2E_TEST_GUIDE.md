# OshiCall E2E テスト手順書

## 概要

OshiCall アプリケーションの完全な E2E テストフローを実行するための手順書です。

## 前提条件

- ローカル環境でフロントエンド・バックエンドが起動済み
- Supabase データベースが利用可能
- Stripe Connect 設定が完了済み
- Daily.co API キーが設定済み

## テストフロー

### 1. ファンアカウント作成

1. ブラウザで `http://localhost:5173` にアクセス
2. 「新規登録」をクリック
3. ファン用のメールアドレス・パスワードでアカウント作成
4. メール認証完了
5. ログイン確認

### 2. インフルエンサーアカウント作成

1. 新しいブラウザタブで `http://localhost:5173` にアクセス
2. 「新規登録」をクリック
3. インフルエンサー用のメールアドレス・パスワードでアカウント作成
4. メール認証完了
5. ログイン確認

### 3. インフルエンサー認証（手動 DB 更新）

```sql
-- Supabase SQL Editorで実行
UPDATE users
SET is_influencer = true
WHERE id = 'uuid';
```

### 4. Stripe Connect アカウント作成

1. インフルエンサーアカウントでマイページにアクセス
2. 「Stripe Connect を設定」ボタンをクリック
3. Stripe のオンボーディングページで情報入力
4. 設定完了後、マイページにリダイレクト
5. 状態が「収益設定完了」になることを確認

### 5. Talk 枠設定

1. インフルエンサーアカウントでマイページにアクセス
2. 「通話枠を設定」をクリック
3. 日時・価格・説明を入力
4. 枠を保存

### 6. Action 開始

1. インフルエンサーアカウントでマイページにアクセス
2. 設定した枠の「Action 開始」をクリック
3. 入札受付開始を確認

### 7. ファン側クレジットカード登録

1. ファンアカウントでマイページにアクセス
2. 「カード登録」をクリック
3. テスト用クレジットカード情報を入力
4. カード登録完了を確認

### 8. Bidding（入札）

1. ファンアカウントでトップページにアクセス
2. インフルエンサーの枠を選択
3. 「入札」をクリック
4. 入札金額を入力
5. 入札を送信

### 9. 複数入札テスト

1. 複数のファンアカウントで同じ通話枠に入札
2. 入札額が競り上がることを確認
3. 最高入札額が正しく表示されることを確認
4. 入札履歴が正しく記録されることを確認

### 10. オークション終了・自動落札テスト

#### 10.1 オークション終了時間の設定

1. インフルエンサーアカウントでマイページにアクセス
2. オークションの終了時間を短く設定（例：2 分後）
3. オークション終了時間を確認

#### 10.2 自動落札処理の確認

1. オークション終了時間を迎えるまで待機
2. オークション終了処理が自動実行されることを確認
3. 最高入札者が落札者として記録されることを確認
4. オークションステータスが「終了」」になることを確認

#### 10.3 落札結果の確認

1. 落札者の Talk ページにアクセス
2. 「落札した Talk」タブで購入した通話枠が表示されることを確認
3. 落札者のマイページで購入履歴が正しく記録されることを確認
4. インフルエンサーのマイページで収益が正しく記録されることを確認

#### 10.4 他の入札者の処理確認

1. 落札者以外の入札者のアカウントで確認
2. 与信がキャンセルされることを確認
3. 入札履歴は残るが、購入記録は作成されないことを確認

### 11. ファン側支払い処理

1. ファンアカウントでマイページにアクセス
2. 落札された通話の支払いを実行
3. 支払い完了を確認

### 12. インフルエンサー側支払い処理

1. インフルエンサーアカウントでマイページにアクセス
2. 収益の確認
3. Stripe Connect 経由での支払い受領確認

### 13. ビデオ通話表示

1. 両アカウントでマイページにアクセス
2. 通話開始ボタンが表示されることを確認
3. 通話 URL が生成されることを確認

### 14. ビデオ通話実施

1. 通話開始ボタンをクリック
2. Daily.co 通話ルームに参加
3. 音声・映像が正常に動作することを確認
4. 通話終了

## 確認ポイント

### データベース確認

- ユーザー情報が正しく保存されている
- Stripe Connect 情報が更新されている
- 入札・落札情報が記録されている
- 支払い情報が記録されている

### 機能確認

- 認証・認可が正常に動作
- Stripe 決済が正常に処理
- Daily.co 通話が正常に動作
- リアルタイム更新が動作

## トラブルシューティング

### よくある問題

1. **Stripe Connect 設定エラー**: サンドボックス環境での制限を確認
2. **Daily.co 接続エラー**: API キー・ドメイン設定を確認
3. **認証エラー**: Supabase 設定を確認
4. **支払いエラー**: Stripe 設定を確認

### ログ確認

- フロントエンド: ブラウザの開発者ツール
- バックエンド: ターミナルのログ出力
- Supabase: Dashboard のログ
- Stripe: Dashboard のログ
