# Staging 環境 E2E テスト手順書

## 概要

Staging 環境（Heroku）での E2E テスト手順書です。新規アカウント作成のテストを含む包括的なテストを実施します。

## 前提条件

- Staging 環境がデプロイ済み
- テスト用アカウントが作成済み（シナリオ失敗時のリセット用）
- ブラウザで Staging 環境にアクセス可能
- Google 認証の設定が完了済み

## テスト用アカウント認証情報（リセット用）

### ファンアカウント（一般ユーザー）

- **URL**: https://oshicall-2936440db16b.herokuapp.com/
- **Email**: `fan-test-01@oshicall.com`
- **Password**: `testpassword123`
- **Role**: 一般ユーザー（ファン）

### インフルエンサーアカウント

- **URL**: https://oshicall-2936440db16b.herokuapp.com/
- **Email**: `influencer-test-01@oshicall.com`
- **Password**: `testpassword123`
- **Role**: インフルエンサー

> **注意**: これらのアカウントはテストシナリオが失敗した場合のリセット用です。新規作成テストは別途実施します。

## E2E テスト手順

### 1. 環境アクセス確認

1. ブラウザで `https://oshicall-2936440db16b.herokuapp.com/` にアクセス
2. ページが正常に読み込まれることを確認
3. ログインボタンが表示されることを確認

### 2. 新規アカウント作成テスト

#### 2.1 Email 認証での新規作成テスト

##### ファンアカウント作成

1. 「新規登録」ボタンをクリック
2. 以下の情報を入力：
   - Email: `new-fan-test@oshicall.com`
   - Password: `newtestpassword123`
   - 確認 Password: `newtestpassword123`
3. 「アカウントを作成」ボタンをクリック
4. メール認証が送信されることを確認
5. メール内の認証リンクをクリック
6. 認証が完了し、ホーム画面が表示されることを確認
7. プロフィール情報が正しく設定されていることを確認：
   - 表示名: デフォルト値
   - ユーザータイプ: 一般ユーザー（ファン）

##### インフルエンサーアカウント作成

1. 新しいブラウザタブで `https://oshicall-2936440db16b.herokuapp.com/` にアクセス
2. 「新規登録」ボタンをクリック
3. 以下の情報を入力：
   - Email: `new-influencer-test@oshicall.com`
   - Password: `newtestpassword123`
   - 確認 Password: `newtestpassword123`
4. 「アカウントを作成」ボタンをクリック
5. メール認証が送信されることを確認
6. メール内の認証リンクをクリック
7. 認証が完了し、ホーム画面が表示されることを確認
8. プロフィール情報が正しく設定されていることを確認：
   - 表示名: デフォルト値
   - ユーザータイプ: 一般ユーザー（ファン）

#### 2.2 Google 認証での新規作成テスト

##### ファンアカウント作成（Google）

1. 新しいブラウザタブで `https://oshicall-2936440db16b.herokuapp.com/` にアクセス
2. 「Google でログイン」ボタンをクリック
3. Google 認証画面が表示されることを確認
4. Google アカウントでログイン
5. 認証が完了し、ホーム画面が表示されることを確認
6. プロフィール情報が正しく設定されていることを確認：
   - 表示名: Google アカウントの名前
   - ユーザータイプ: 一般ユーザー（ファン）

##### インフルエンサーアカウント作成（Google）

1. 新しいブラウザタブで `https://oshicall-2936440db16b.herokuapp.com/` にアクセス
2. 「Google でログイン」ボタンをクリック
3. 別の Google アカウントでログイン
4. 認証が完了し、ホーム画面が表示されることを確認
5. プロフィール情報が正しく設定されていることを確認：
   - 表示名: Google アカウントの名前
   - ユーザータイプ: 一般ユーザー（ファン）

#### 2.3 インフルエンサー権限付与テスト

##### Supabase での権限付与

1. Supabase ダッシュボードにアクセス
2. SQL Editor を開く
3. 以下の SQL を実行してインフルエンサー権限を付与：

```sql
-- Email認証で作成したアカウントをインフルエンサーに変更
UPDATE profiles
SET
  is_influencer = true,
  total_earnings = 0,
  total_calls_completed = 0,
  average_rating = 0.0,
  updated_at = now()
WHERE id = (SELECT id FROM auth.users WHERE email = 'new-influencer-test@oshicall.com');

-- Google認証で作成したアカウントをインフルエンサーに変更
-- 注意: Google認証の場合、実際のGoogleアカウントのEmailアドレスを使用
UPDATE profiles
SET
  is_influencer = true,
  total_earnings = 0,
  total_calls_completed = 0,
  average_rating = 0.0,
  updated_at = now()
WHERE id = (SELECT id FROM auth.users WHERE email = 'your-google-account@gmail.com');
```

### ユーザー ID 確認方法

権限付与前に、作成されたアカウントのユーザー ID を確認する方法：

```sql
-- 作成されたユーザー一覧を確認
SELECT
  u.id,
  u.email,
  u.created_at,
  p.username,
  p.display_name,
  p.is_influencer
FROM auth.users u
LEFT JOIN profiles p ON u.id = p.id
WHERE u.email LIKE '%test%' OR u.email LIKE '%@gmail.com'
ORDER BY u.created_at DESC;
```

##### 権限付与後の確認

1. インフルエンサーアカウントでログイン
2. マイページにアクセス
3. インフルエンサー用のダッシュボードが表示されることを確認：
   - Talk 枠管理セクションが表示される
   - 統計情報が表示される
   - 新規作成ボタンが表示される

### より実用的な手順（推奨）

#### 手順 1: ユーザー ID 確認

```sql
-- 最新に作成されたユーザーを確認
SELECT
  u.id,
  u.email,
  u.created_at,
  p.username,
  p.display_name,
  p.is_influencer
FROM auth.users u
LEFT JOIN profiles p ON u.id = p.id
WHERE u.created_at > now() - interval '1 hour'
ORDER BY u.created_at DESC;
```

#### 手順 2: 特定のユーザー ID で権限付与

```sql
-- 確認したユーザーIDを使用して権限付与
-- 例: ユーザーIDが '12345678-1234-1234-1234-123456789abc' の場合
UPDATE profiles
SET
  is_influencer = true,
  total_earnings = 0,
  total_calls_completed = 0,
  average_rating = 0.0,
  updated_at = now()
WHERE id = '12345678-1234-1234-1234-123456789abc';
```

#### 手順 3: 権限付与確認

```sql
-- 権限付与が成功したか確認
SELECT
  u.email,
  p.username,
  p.display_name,
  p.is_influencer,
  p.total_earnings,
  p.total_calls_completed,
  p.average_rating
FROM auth.users u
JOIN profiles p ON u.id = p.id
WHERE u.email = 'new-influencer-test@oshicall.com';
```

### 3. 既存アカウントでの機能テスト

#### 3.1 ファンアカウントでのテスト

##### 3.1.1 ログイン

1. 「ログイン」ボタンをクリック
2. 認証情報を入力：
   - Email: `fan-test-01@oshicall.com`
   - Password: `testpassword123`
3. ログインが成功することを確認
4. ホーム画面が表示されることを確認

##### 3.1.2 プロフィール確認

1. 右上のユーザーアイコンをクリック
2. 「マイページ」を選択
3. プロフィール情報が正しく表示されることを確認：
   - 表示名: テストファン 01
   - ユーザータイプ: 一般ユーザー
   - 統計情報（支払い額、通話数、ポイント）

##### 3.1.3 Talk 一覧確認

1. 「Talk」タブをクリック
2. Talk 一覧が表示されることを確認
3. 各 Talk の詳細情報が正しく表示されることを確認：
   - タイトル
   - 説明
   - 開始価格
   - 残り時間
   - 入札者数

##### 3.1.4 入札機能テスト

1. 任意の Talk をクリック
2. Talk 詳細画面が表示されることを確認
3. 「入札する」ボタンをクリック
4. 入札金額を入力（例：5000 円）
5. 入札が成功することを確認
6. 入札履歴が更新されることを確認

##### 3.1.5 ランキング確認

1. 「ランキング」タブをクリック
2. ランキング一覧が表示されることを確認
3. 各インフルエンサーの情報が正しく表示されることを確認

#### 3.2 インフルエンサーアカウントでのテスト

##### 3.2.1 ログイン

1. 新しいブラウザタブで `https://oshicall-2936440db16b.herokuapp.com/` にアクセス
2. 「ログイン」ボタンをクリック
3. 認証情報を入力：
   - Email: `influencer-test-01@oshicall.com`
   - Password: `testpassword123`
4. ログインが成功することを確認

##### 3.2.2 インフルエンサーダッシュボード確認

1. 右上のユーザーアイコンをクリック
2. 「マイページ」を選択
3. インフルエンサー用のダッシュボードが表示されることを確認：
   - 総収益: ¥150,000
   - 完了通話数: 25
   - 平均評価: 4.9
   - Talk 枠数

##### 3.2.3 Talk 枠管理機能テスト

1. Talk 枠セクションが表示されることを確認
2. 「新規作成」ボタンをクリック
3. Talk 枠作成フォームが表示されることを確認
4. 以下の情報を入力：
   - タイトル: テスト Talk 枠
   - 説明: テスト用の Talk 枠です
   - 開始日時: 明日の日時
   - 通話時間: 30 分
   - 開始価格: 3000 円
   - 最小入札単位: 500 円
5. 「Talk 枠を作成」ボタンをクリック
6. 作成が成功することを確認
7. Talk 枠一覧に新規作成した枠が表示されることを確認

##### 3.2.4 Talk 枠タブ機能テスト

1. 「予定」タブが選択されていることを確認
2. 「履歴」タブをクリック
3. 完了した Talk 枠が表示されることを確認
4. 「予定」タブに戻ることを確認

##### 3.2.5 Talk 枠操作テスト

1. 作成した Talk 枠の「公開/非公開」ボタンをクリック
2. 状態が変更されることを確認
3. 削除ボタンをクリック
4. 削除が成功することを確認

### 4. クロスアカウントテスト

#### 4.1 入札とオークション

1. ファンアカウントで任意の Talk に入札
2. インフルエンサーアカウントで入札状況を確認
3. 入札履歴が正しく表示されることを確認

#### 4.2 通話機能（モック）

1. オークション終了後の通話開始ボタンをクリック
2. 通話画面が表示されることを確認（実際の通話は行わない）
3. 通話終了ボタンをクリック
4. 通話が終了することを確認

### 5. レスポンシブテスト

#### 5.1 モバイル表示確認

1. ブラウザの開発者ツールを開く
2. モバイル表示（375px）に切り替え
3. 各ページが正しく表示されることを確認：
   - ホーム画面
   - Talk 一覧
   - マイページ
   - プロフィール設定

#### 5.2 タブレット表示確認

1. タブレット表示（768px）に切り替え
2. レイアウトが適切に調整されることを確認

### 6. エラーハンドリングテスト

#### 6.1 ネットワークエラー

1. ブラウザの開発者ツールでネットワークを無効化
2. ページの動作を確認
3. 適切なエラーメッセージが表示されることを確認

#### 6.2 認証エラー

1. 無効な認証情報でログインを試行
2. 適切なエラーメッセージが表示されることを確認

## テスト結果の記録

### チェックリスト

#### 新規アカウント作成テスト

- [ ] Email 認証でのファンアカウント作成成功
- [ ] Email 認証でのインフルエンサーアカウント作成成功
- [ ] Google 認証でのファンアカウント作成成功
- [ ] Google 認証でのインフルエンサーアカウント作成成功
- [ ] インフルエンサー権限付与成功
- [ ] 権限付与後のダッシュボード表示正常

#### 既存アカウント機能テスト

- [ ] ファンアカウントログイン成功
- [ ] ファンプロフィール表示正常
- [ ] Talk 一覧表示正常
- [ ] 入札機能正常
- [ ] ランキング表示正常
- [ ] インフルエンサーアカウントログイン成功
- [ ] インフルエンサーダッシュボード表示正常
- [ ] Talk 枠作成機能正常
- [ ] Talk 枠管理機能正常
- [ ] クロスアカウント連携正常
- [ ] モバイル表示正常
- [ ] タブレット表示正常
- [ ] エラーハンドリング正常

### 発見された問題

- [ ] 問題 1: 詳細を記録
- [ ] 問題 2: 詳細を記録
- [ ] 問題 3: 詳細を記録

### 改善提案

- [ ] 提案 1: 詳細を記録
- [ ] 提案 2: 詳細を記録
- [ ] 提案 3: 詳細を記録

## 注意事項

- テスト用アカウントは本番環境では使用しないでください
- テスト中に作成したデータは必要に応じて削除してください
- パフォーマンステストは別途実施してください
- セキュリティテストは別途実施してください

## 関連ドキュメント

- [ローカル環境 E2E テスト手順書](./E2E_TEST_GUIDE.md)
- [テスト用アカウント認証情報](../TEST_ACCOUNTS.md)
- [デプロイ手順書](../UNIFIED_DEPLOYMENT.md)
